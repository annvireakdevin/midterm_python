{# templates/admin/products.html #}
{% extends "Layout/base.html" %}
{% block title %}Admin · Products{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h1 class="h3 mb-0">Products</h1>
  <div class="d-flex gap-2">
    <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary">Dashboard</a>
    <a href="{{ url_for('admin.products_create') }}" class="btn btn-primary">+ New</a>
  </div>
</div>

<form method="get" class="row g-2 mb-3">
  <div class="col-sm-8 col-md-6">
    <input
      name="q"
      class="form-control"
      placeholder="Search title/category"
      value="{{ q|default('')|e }}"
    >
  </div>
  <div class="col-auto">
    <button type="submit" class="btn btn-outline-primary">Search</button>
  </div>
  {% if q %}
  <div class="col-auto">
    <a class="btn btn-outline-secondary" href="{{ url_for('admin.products_index') }}">Clear</a>
  </div>
  {% endif %}
</form>

{# flash messages #}
{% with msgs = get_flashed_messages(with_categories=true) %}
  {% if msgs %}
    {% for cat, msg in msgs %}
      <div class="alert alert-{{ 'success' if cat=='success' else 'danger' }} alert-dismissible fade show" role="alert">
        {{ msg }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th style="width:80px">ID</th>
          <th>Title</th>
          <th style="width:120px">Price</th>
          <th style="width:180px">Category</th>
          <th style="width:160px">Rating</th>
          <th style="width:160px">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for p in products %}
        <tr>
          <td>{{ p.id }}</td>
          <td class="text-truncate" style="max-width: 420px;" title="{{ p.title }}">{{ p.title }}</td>
          <td>${{ '%.2f'|format(p.price or 0) }}</td>
          <td>{{ p.category or '—' }}</td>
          <td>{{ '%.1f'|format(p.rating_rate or 0) }} ({{ p.rating_count or 0 }})</td>
          <td>
            <a href="{{ url_for('admin.products_edit', pid=p.id) }}" class="btn btn-sm btn-outline-primary">Edit</a>
            <form
              action="{{ url_for('admin.products_delete', pid=p.id) }}"
              method="post"
              class="d-inline"
              onsubmit="return confirm('Delete this product?')"
            >
              <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="6" class="text-center text-muted py-4">No products found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% if pagination.pages > 1 %}
<nav aria-label="Products pagination" class="mt-3">
  <ul class="pagination mb-0">
    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
      <a class="page-link"
         href="{{ url_for('admin.products_index', page=pagination.prev_num, q=q) }}"
         tabindex="-1">« Prev</a>
    </li>

    {# show numbered pages with ellipses #}
    {% for page in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
      {% if page %}
        <li class="page-item {% if page == pagination.page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('admin.products_index', page=page, q=q) }}">{{ page }}</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">…</span></li>
      {% endif %}
    {% endfor %}

    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
      <a class="page-link"
         href="{{ url_for('admin.products_index', page=pagination.next_num, q=q) }}">Next »</a>
    </li>
  </ul>
</nav>
{% endif %}
{% endblock %}

