
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cart</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body { background-color: #f5f5f7; font-family: 'Inter', sans-serif; color: #1d1d1f; }
    .cart-item, .order-summary {
      background-color: #ffffff; border-radius: 12px; padding: 20px;
      margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    .cart-item-image { width: 80px; height: 80px; object-fit: contain; border-radius: 8px; }
    .product-title { font-weight: 600; font-size: 1.1rem; }
    .product-price { font-weight: 700; font-size: 1.25rem; }
    .quantity-selector { display: flex; align-items: center; background-color: #f5f5f7; border-radius: 20px; padding: 4px; }
    .quantity-selector .btn {
      border-radius: 50%; width: 28px; height: 28px; line-height: 1; padding: 0;
      background-color: #ffffff; color: #1d1d1f; border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .quantity-value { padding: 0 15px; font-weight: 500; }
    .remove-btn { color: #d9534f; cursor: pointer; }
    .remove-btn:hover { color: #c9302c; }
    .order-summary h3 { font-weight: 700; margin-bottom: 1.5rem; }
    .summary-item { display: flex; justify-content: space-between; margin-bottom: 1rem; }
    .summary-total { font-size: 1.25rem; font-weight: 700; }
  </style>
</head>
<body>

<div class="container mt-5" id="hasNoProduct" style="display: none;">
  <div class="card p-4 shadow-sm">
    <h5 class="card-title mb-4">ðŸ§¾ Order Summary</h5>
    <p class="text-muted mb-4">Your cart is empty.</p>
    <a href="/product" class="btn btn-primary">Return to Shop</a>
  </div>
</div>

<div class="container" id="hasProduct" style="display: none;">
  <div class="row">
    <div class="col-lg-8" id="cartItems"></div>
    <div class="col-lg-4">
      <div class="order-summary">
        <h3>Order Summary</h3>
        <div class="summary-item"><span>Subtotal</span> <span id="sub_total">$0.00</span></div>
        <div class="summary-item"><span>Delivery Fee</span> <span>$0.00</span></div>
        <hr>
        <div class="summary-item summary-total"><span>Total</span> <span id="total">$0.00</span></div>
        <a href="/checkout" id="btnCheckOut" class="btn btn-success w-100 mt-3">Go to Checkout</a>
      </div>
    </div>
  </div>
</div>

<script>
  /**
   * We now only trust localStorage for id & quantity.
   * We fetch real product data from the DB for those ids.
   */
  async function fetchProductsByIds(ids) {
    const res = await fetch("/api/products/by_ids", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ ids })
    });
    if (!res.ok) throw new Error("Failed to load products");
    return await res.json(); // { "1": {id:1,title:...}, ... }
  }

  function readCart() {
    // allow legacy carts that stored title/price/image; we only use id/quantity now
    const raw = JSON.parse(localStorage.getItem("cart_list") || "[]");
    return raw.map(x => ({ id: Number(x.id), quantity: Number(x.quantity || 1) }))
              .filter(x => Number.isFinite(x.id) && x.id > 0 && x.quantity > 0);
  }

  function writeCart(cart) {
    localStorage.setItem("cart_list", JSON.stringify(cart));
  }

  async function renderCart() {
    const hasNoProduct = document.getElementById("hasNoProduct");
    const hasProduct = document.getElementById("hasProduct");
    const container = document.getElementById("cartItems");
    const cart = readCart();

    if (!cart.length) {
      hasNoProduct.style.display = "block";
      hasProduct.style.display = "none";
      return;
    }

    // Fetch current product data from DB
    const ids = [...new Set(cart.map(i => i.id))];
    let productMap = {};
    try {
      productMap = await fetchProductsByIds(ids);
    } catch (e) {
      console.error(e);
      // If the API fails, show empty state (or keep last render)
      hasNoProduct.style.display = "block";
      hasProduct.style.display = "none";
      return;
    }

    // Build UI
    hasProduct.style.display = "block";
    hasNoProduct.style.display = "none";
    container.innerHTML = "";

    let total = 0;

    // Remove any items whose product no longer exists
    const filteredCart = [];
    for (const item of cart) {
      const p = productMap[item.id];
      if (!p) continue;  // product was deleted from DB
      filteredCart.push(item);

      const itemTotal = p.price * item.quantity;
      total += itemTotal;

      container.innerHTML += `
        <div class="cart-item d-flex justify-content-between align-items-center" data-id="${p.id}">
          <div class="d-flex align-items-center">
            <img src="${p.image || ''}" alt="${escapeHtml(p.title)}" class="cart-item-image me-3">
            <div>
              <div class="product-title">${escapeHtml(p.title)}</div>
              <div class="product-price">$${Number(p.price).toFixed(2)}</div>
            </div>
          </div>
          <div class="d-flex align-items-center">
            <div class="quantity-selector">
              <button class="btn" onclick="changeQuantity(${p.id}, -1)">âˆ’</button>
              <span class="quantity-value">${item.quantity}</span>
              <button class="btn" onclick="changeQuantity(${p.id}, 1)">+</button>
            </div>
            <button class="btn" onclick="removeItem(${p.id})"><i class="bi bi-trash-fill remove-btn fs-5 ms-3"></i></button>
          </div>
        </div>`;
    }

    // Persist cleaned cart if we dropped any missing products
    if (filteredCart.length !== cart.length) writeCart(filteredCart);

    document.getElementById("sub_total").textContent = `$${total.toFixed(2)}`;
    document.getElementById("total").textContent = `$${total.toFixed(2)}`;
  }

  function changeQuantity(id, delta) {
    const cart = readCart();
    const item = cart.find(i => i.id === id);
    if (item) {
      item.quantity += delta;
      if (item.quantity <= 0) item.quantity = 1;
      writeCart(cart);
      renderCart();
    }
  }

  function removeItem(id) {
    const cart = readCart().filter(i => i.id !== id);
    writeCart(cart);
    renderCart();
  }

  // tiny escape for safety in innerHTML
  function escapeHtml(s) {
    return String(s ?? "").replace(/[&<>"']/g, m => (
      { "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]
    ));
  }

  // Initial render
  renderCart();
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

